name: AI Code Review

on:
  pull_request:
    branches:
      - main
      - master
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  review:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Get PR Diff
        run: |
          curl -L \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3.diff" \
            ${{ github.event.pull_request.url }} \
            > diff.txt

      - name: Check Diff Empty
        run: |
          if [ ! -s diff.txt ]; then
            echo "No changes detected in PR."
            exit 1
          fi

      - name: Call Claude API
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          python3 << 'EOF'
          import json, urllib.request, os

          try:
              with open('diff.txt', 'r') as f:
                  diff_content = f.read()

              payload = {
                  "model": "claude-sonnet-4-5-20250929",
                  "max_tokens": 1200,
                  "messages": [{
                      "role": "user",
                      "content": """ë‹¹ì‹ ì€ 10ë…„ ê²½ë ¥ì˜ ì‹œë‹ˆì–´ ì•ˆë“œë¡œì´ë“œ ì—”ì§€ë‹ˆì–´ìž…ë‹ˆë‹¤.

ë‹¤ìŒ Kotlin PR diffë¥¼ ì½”ë“œ ë¦¬ë·°í•´ì£¼ì„¸ìš”.

ë‹¤ìŒ í•­ëª©ì„ ì¤‘ì ì ìœ¼ë¡œ ë¶„ì„í•˜ì„¸ìš”:

1. Coroutine ì•ˆì „ì„± (viewModelScope, lifecycleScope, cancellation ë¬¸ì œ)
2. Lifecycle ë©”ëª¨ë¦¬ ëˆ„ìˆ˜ ê°€ëŠ¥ì„±
3. MVVM / Clean Architecture ìœ„ë°˜ ì—¬ë¶€
4. Compose ìž¬êµ¬ì„±(Recomposition) ë¹„íš¨ìœ¨
5. ìƒíƒœ ê´€ë¦¬ ë¬¸ì œ (State hoisting, remember misuse ë“±)
6. ì„±ëŠ¥ ë¬¸ì œ
7. ê°€ë…ì„± ë° ìœ ì§€ë³´ìˆ˜ì„±

ë¦¬ë·° í˜•ì‹ì€ ë‹¤ìŒê³¼ ê°™ì´ ìž‘ì„±í•´ì£¼ì„¸ìš”:

## ðŸ”´ ì¹˜ëª…ì  ë¬¸ì œ
- ë¬¸ì œ ì„¤ëª…
- ì™œ ë¬¸ì œì¸ì§€
- ê°œì„  ì½”ë“œ ì˜ˆì‹œ

## âš ï¸ ê°œì„  ê¶Œìž¥ ì‚¬í•­
- ë¬¸ì œ ì„¤ëª…
- ê°œì„  ë°©ë²•

## ðŸŸ¢ ìž˜ ìž‘ì„±ëœ ë¶€ë¶„
- ê¸ì •ì  í”¼ë“œë°±

ì•„ëž˜ëŠ” PR diff ìž…ë‹ˆë‹¤:

""" + diff_content
                  }]
              }

              data = json.dumps(payload).encode('utf-8')

              req = urllib.request.Request(
                  'https://api.anthropic.com/v1/messages',
                  data=data,
                  headers={
                      'x-api-key': os.environ['ANTHROPIC_API_KEY'],
                      'anthropic-version': '2023-06-01',
                      'content-type': 'application/json'
                  }
              )

              with urllib.request.urlopen(req) as res:
                  response = json.loads(res.read())

          except Exception as e:
              response = {"error": str(e)}

          with open('review.json', 'w') as f:
              json.dump(response, f)
          EOF

      - name: Debug Response
        if: always()
        run: cat review.json

      - name: Post Review Comment
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const review = JSON.parse(fs.readFileSync('review.json', 'utf8'));

            if (review.error) {
              console.log('Claude API error:', review.error);
              core.setFailed('Claude API failed: ' + review.error);
              return;
            }

            if (!review.content || !review.content[0]) {
              console.log('Unexpected response:', JSON.stringify(review));
              core.setFailed('Claude API did not return expected content.');
              return;
            }

            const comment = review.content[0].text;

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '## ðŸ¤– AI ì½”ë“œ ë¦¬ë·°\n\n' + comment
            });

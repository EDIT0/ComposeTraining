name: AI Code Review

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  review:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Get PR Diff
        run: |
          git fetch origin ${{ github.base_ref }}
          git diff origin/${{ github.base_ref }} > diff.txt

      - name: Call Claude API
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          python3 << 'EOF'
          import json, urllib.request, os, sys

          try:
              with open('diff.txt', 'r') as f:
                  diff_content = f.read()

              payload = {
                  "model": "claude-3-5-sonnet-latest",
                  "max_tokens": 1000,
                  "messages": [{
                      "role": "user",
                      "content": "You are a senior Android engineer. Review this Kotlin PR diff focusing on coroutine safety, lifecycle leaks, architecture violations, and performance issues:\n\n" + diff_content
                  }]
              }

              data = json.dumps(payload).encode('utf-8')

              req = urllib.request.Request(
                  'https://api.anthropic.com/v1/messages',
                  data=data,
                  headers={
                      'x-api-key': os.environ['ANTHROPIC_API_KEY'],
                      'anthropic-version': '2023-06-01',
                      'content-type': 'application/json'
                  }
              )

              with urllib.request.urlopen(req) as res:
                  response = json.loads(res.read())

          except Exception as e:
              response = {"error": str(e)}

          with open('review.json', 'w') as f:
              json.dump(response, f)
          EOF

      - name: Debug Response
        if: always()
        run: cat review.json

      - name: Post Review Comment
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const review = JSON.parse(fs.readFileSync('review.json', 'utf8'));

            if (review.error) {
              console.log('Claude API error:', review.error);
              core.setFailed('Claude API failed: ' + review.error);
              return;
            }

            if (!review.content || !review.content[0]) {
              console.log('Unexpected response:', JSON.stringify(review));
              core.setFailed('Claude API did not return expected content.');
              return;
            }

            const comment = review.content[0].text;

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '## ðŸ¤– AI Code Review\n\n' + comment
            });

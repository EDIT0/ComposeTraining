name: AI Code Review

on:
  pull_request_target:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  review:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Get PR Diff
        run: |
          curl -L \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3.diff" \
            ${{ github.event.pull_request.url }} \
            > diff.txt

      - name: Check Diff Empty
        run: |
          if [ ! -s diff.txt ]; then
            echo "No changes detected in PR."
            exit 1
          fi

      - name: Call Claude API
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          python3 << 'EOF'
          import json, urllib.request, os

          try:
              with open('diff.txt', 'r') as f:
                  diff_content = f.read()

              payload = {
                  "model": "claude-haiku-4-5-20251001",
                  "max_tokens": 2500,
                  "messages": [{
                      "role": "user",
                      "content": "ë‹¤ìŒ Kotlin PR diffë¥¼ í•œêµ­ì–´ë¡œ ì½”ë“œ ë¦¬ë·°í•´ì£¼ì„¸ìš”:\n\n" + diff_content
                  }]
              }

              data = json.dumps(payload).encode('utf-8')

              req = urllib.request.Request(
                  'https://api.anthropic.com/v1/messages',
                  data=data,
                  headers={
                      'x-api-key': os.environ['ANTHROPIC_API_KEY'],
                      'anthropic-version': '2023-06-01',
                      'content-type': 'application/json'
                  }
              )

              with urllib.request.urlopen(req) as res:
                  response = json.loads(res.read())

          except Exception as e:
              response = {"error": str(e)}

          with open('review.json', 'w') as f:
              json.dump(response, f)
          EOF

      - name: Post Review Comment
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const review = JSON.parse(fs.readFileSync('review.json', 'utf8'));

            if (!review.content || !review.content[0]) {
              core.setFailed('Claude API did not return expected content.');
              return;
            }

            const comment = review.content[0].text;

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '## ðŸ¤– AI ì½”ë“œ ë¦¬ë·°\n\n' + comment
            });
